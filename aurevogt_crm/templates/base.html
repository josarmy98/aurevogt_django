{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{% block title %}AUREVOGT CRM{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind (CDN para MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <!-- Alpine (opcional para toggles sencillos) -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Chart.js (por si alguna vista lo necesita) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (CSS) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
  
  <style>
    /* Altura por defecto para contenedores de mapa (Leaflet) */
    .map-container { height: 380px; }
    /* Asegura que el canvas interno de Leaflet tenga altura visible */
    .leaflet-container { min-height: 380px; }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Navbar -->
  {% if request.user.is_authenticated %}
  <nav class="bg-white border-b shadow-sm">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-6">
          <a href="{% url 'dashboard' %}" class="font-bold tracking-wide">AUREVOGT</a>
          <div class="hidden md:flex items-center gap-4 text-sm">
            {% if request.user.is_superuser %}
              <a href="{% url 'users:create' %}" class="text-sm hover:text-gray-700">Crear usuario</a>
            {% endif %}
            <a href="{% url 'packages:list' %}" class="text-blue-600 hover:underline">Paquetes</a>
            <a href="{% url 'drivers:list' %}" class="text-blue-600 hover:underline">Conductores</a>
            <a href="{% url 'assignments:list' %}" class="text-blue-600 hover:underline">Asignaciones</a>
            <a href="{% url 'imports:list' %}" class="text-blue-600 hover:underline">Importaciones</a>
            <div class="relative group">
              <button class="hover:text-gray-700">Reportes</button>
              <div class="absolute hidden group-hover:block bg-white border shadow rounded mt-2 p-2 z-10">
                <a href="/reports/dashboard/" class="block px-3 py-1 hover:bg-gray-50 rounded">Dashboard</a>
                <a href="/api/reports/productivity/" class="block px-3 py-1 hover:bg-gray-50 rounded">Por conductor</a>
                <a href="/reports/sla/" class="block px-3 py-1 hover:bg-gray-50 rounded">SLA</a>
                <a href="/reports/failed/" class="block px-3 py-1 hover:bg-gray-50 rounded">Fallos</a>
              </div>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <span class="text-sm">Hola, {{ request.user.first_name|default:request.user.username }}</span>
          <a href="{% url 'profile' %}" class="text-sm hover:text-gray-700">Perfil</a>
          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button class="text-sm text-red-600 hover:text-red-700">Salir</button>
          </form>
        </div>
      </div>
    </div>
  </nav>
  {% endif %}

  <!-- Flash messages -->
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-4">
    {% if messages %}
      <div class="space-y-2">
        {% for message in messages %}
          <div class="p-3 rounded text-sm
              {% if message.tags == 'success' %} bg-green-50 text-green-700 border border-green-200
              {% elif message.tags == 'warning' %} bg-yellow-50 text-yellow-800 border border-yellow-200
              {% elif message.tags == 'error' %} bg-red-50 text-red-700 border border-red-200
              {% else %} bg-blue-50 text-blue-700 border border-blue-200 {% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Page content -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
    {% block content %}{% endblock %}
  </main>

  <!-- Leaflet (JS) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    /**
     * Inicializa un mapa con marcadores de drivers usando Leaflet + OpenStreetMap.
     * @param {string} elId - id del elemento contenedor del mapa
     * @param {Array<{lat:number,lng?:number,lon?:number,label?:string,id?:number,captured_at?:string}>} points
     * @param {Object} [opts]  // {lat?:number,lng?:number,zoom?:number,height?:number}
     * @returns {L.Map|null}
     */
    window.initDriverMap = function(elId, points = [], opts = {}) {
      if (typeof L === 'undefined') {
        console.error('Leaflet no está cargado.');
        return null;
      }

      const el = document.getElementById(elId);
      if (!el) {
        console.error('No existe contenedor de mapa con id:', elId);
        return null;
      }

      // Asegura una altura visible del contenedor
      const desiredH = typeof opts.height === 'number' ? opts.height : 420;
      const currentH = parseInt(getComputedStyle(el).height || '0', 10);
      if (!currentH || currentH < 100) el.style.height = desiredH + 'px';

      const center = [
        (typeof opts.lat === 'number' ? opts.lat : 25.7617),
        (typeof opts.lng === 'number' ? opts.lng : -80.1918)
      ];
      const zoom = (typeof opts.zoom === 'number' ? opts.zoom : 10);

      const map = L.map(el).setView(center, zoom);
      // Corrige tamaño si el elemento estaba oculto/invisible al cargar
      setTimeout(() => map.invalidateSize(), 0);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Normaliza lng/lon
      const normalize = (p) => ({
        lat: p.lat,
        lng: (p.lng !== undefined ? p.lng : p.lon),
        label: p.label,
        id: p.id,
        captured_at: p.captured_at
      });

      const valid = Array.isArray(points)
        ? points.map(normalize).filter(p => typeof p.lat === 'number' && typeof p.lng === 'number')
        : [];

      const bounds = [];
      valid.forEach(p => {
        const marker = L.marker([p.lat, p.lng]).addTo(map);
        if (p.label || p.captured_at) {
          const when = p.captured_at ? new Date(p.captured_at).toLocaleString() : '';
          const title = p.label || `Driver #${p.id ?? ''}`;
          marker.bindPopup(`<div style="min-width:180px"><strong>${title}</strong><br>Lat: ${p.lat.toFixed(5)}<br>Lng: ${p.lng.toFixed(5)}<br><span style="color:#6b7280">${when}</span></div>`);
        }
        bounds.push([p.lat, p.lng]);
      });

      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [20, 20] });
      } else if (bounds.length === 1) {
        map.setView(bounds[0], Math.max(zoom, 13));
      }

      return map;
    };
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>